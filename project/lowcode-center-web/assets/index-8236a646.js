import{d as e,f as a,r as l,I as o,av as t,a as r,q as s,t as d,i,C as n,o as m,F as c,j as u,n as p,w as h,m as g,l as b,k as y,a8 as f,a9 as w,B as v,Z as S,y as M,ax as E,G as V}from"./index-455b6c01.js";import{o as _,a as T}from"./constant-bd962a5b.js";import{v as x,T as q,g as C,b as k,c as P,d as z,e as D,u as j,p as U,f as O}from"./index-088e6ea1.js";import{S as L}from"./SchemaRender-0f9c0dff.js";import"./loader-421e4912.js";const R={style:{width:"100%",height:"360px"}},A={class:"dialog-footer"},Y={style:{width:"100%",height:"360px"}},$={class:"dialog-footer"};const H=e({...e({name:"TemplateCenterList"}),setup(e){a();const H=l(),I=l(),B=l();l({Authorization:`Bearer ${o()||""}`});const F=l(`${window.location.origin}${window.location.pathname}#/sysManage/formDesign`),N={automaticLayout:!0,formatOnType:!0,formatOnPaste:!0,language:"json"},W={automaticLayout:!0,formatOnType:!0,formatOnPaste:!0,language:"json",readOnly:!0};l("// some code...");const G=t(),Z=t(),J=e=>G.value=e,K=e=>Z.value=e,Q=()=>{ae.isShowModal=!0,B.value=null,ae.modal={isEdit:!1,description:"",code:"",name:"",dictionaryValue:"",schema:""}},X=l({code:[{required:!0,message:"请输入编码",trigger:"blur"},{trigger:"blur",validator:async(e,a,l)=>{if(!a)return l(new Error("请输入请输入编码"));if(a.length>50)return l(new Error("编码不能超过50字符"));if(ae.modal.isEdit)return l();if(!/^[a-zA-Z0-9-]+$/.test(a))return l(new Error("编码只能是英文字母、数字和中划线的组合"));try{return(await x(a)).data?l():l(new Error("该字典已存在，请更换"))}catch(o){return l(new Error("系统异常，请稍后重试"))}}}],name:[{required:!0,message:"请输入名称",trigger:"blur"}],description:[{required:!0,message:"请输入描述",trigger:"blur"}],schema:[{required:!0,message:"请输入schema",trigger:"blur"},{trigger:"blur",validator:async(e,a,l)=>a?l():l(new Error("请输入schema"))}]}),ee=l({code:[{required:!0,message:"请输入编码",trigger:"blur"},{trigger:"blur",validator:async(e,a,l)=>{if(!a)return l(new Error("请输入请输入编码"));if(a.length>50)return l(new Error("编码不能超过50字符"));if(ae.modal.isEdit)return l();if(!/^[a-zA-Z0-9-]+$/.test(a))return l(new Error("编码只能是英文字母、数字和中划线的组合"));try{return(await x(a)).data?l():l(new Error("该字典已存在，请更换"))}catch(o){return l(new Error("系统异常，请稍后重试"))}}}],logs:[{required:!0,message:"不能为空",trigger:"blur"}],versionType:[{required:!0,message:"不能为空",trigger:"blur"}],schema:[{required:!0,message:"请输入schema",trigger:"blur"},{trigger:"blur",validator:async(e,a,l)=>a?l():l(new Error("请输入schema"))}]}),ae=r({isShowModal:!1,modal:{isEdit:!1,name:"",code:"",schema:"",dictionaryValue:"",description:""}}),le=r({isShowModal:!1,modal:{schema:""}}),oe=r({isShowModal:!1,modal:{code:"",schema:"",version:"",versionType:"",logs:""}}),te=r({isShowModal:!1,modal:{table:{layout:"total,sizes, slot, prev, pager, next, jumper",total:0,pageSize:20,currentPage:1,data:[],columns:[{prop:"version",label:"版本"},{prop:"crateTimeLabel",label:"发布时间"}],operator:[{render:(e,a)=>s("span",{onClick:()=>me(a)},[d("预览")])}],operatorConfig:{fixed:"right",align:"center",width:"140",label:"操作"}},query:{version:"",code:""}}}),re=()=>{ae.isShowModal=!1,B.value=null,ae.modal={isEdit:!1,description:"",code:"",name:"",dictionaryValue:"",schema:""}},se=()=>{oe.isShowModal=!1,B.value=null,oe.modal={version:"",versionType:"",logs:"",code:"",schema:""}},de=async()=>{var e;if(await(null==(e=I.value)?void 0:e.validate()))if(ae.modal.isEdit){(await j(B.value.id,{code:ae.modal.code,name:ae.modal.name,schema:ae.modal.schema,description:ae.modal.description})).success?(M.success("操作成功"),ae.isShowModal=!1,ae.modal={isEdit:!1,description:"",code:"",name:"",dictionaryValue:"",schema:""},B.value=null,ge("search")):M.error("操作失败")}else{(await D({code:ae.modal.code,name:ae.modal.name,schema:ae.modal.schema,description:ae.modal.description})).success?(M.success("操作成功"),ae.isShowModal=!1,ae.modal={isEdit:!1,description:"",code:"",name:"",dictionaryValue:"",schema:""},B.value=null,ge("search")):M.error("操作失败")}},ie=async()=>{var e;if(await(null==(e=I.value)?void 0:e.validate())){(await U({code:oe.modal.code,versionType:oe.modal.versionType,logs:oe.modal.logs})).success?(M.success("操作成功"),oe.isShowModal=!1,B.value=null,oe.modal={version:"",versionType:"",logs:"",code:"",schema:""},ge("search")):M.error("操作失败")}},ne=e=>{le.isShowModal=!0,le.modal.schema=e.schema},me=e=>{le.isShowModal=!0,le.modal.schema=e.schema},ce=e=>{le.isShowModal=!1,le.modal.schema="{}"},ue=r({query:{code:"",name:""},roleIds:[],table:{total:0,pageSize:20,currentPage:1,data:[],columns:[{prop:"name",label:"名称"},{prop:"code",label:"编码"},{prop:"renderType",label:"渲染框架"},{prop:"status",label:"状态",render:(e,a)=>e?e===q.DRAFT?s(i("el-tag"),{type:"primary"},{default:()=>[d("草稿")]}):e===q.PUBLISHED?s(i("el-tag"),{type:"success"},{default:()=>[d("已发布("),a.version,d(")")]}):e===q.DEPRECATED?s(i("el-tag"),{type:"info"},{default:()=>[d("已弃用")]}):"-":"-"},{prop:"tags",label:"tags",minWidth:80,render:(e,a)=>{const l=(a.tags||"").split(",");return l.length&&a.tags?s("div",null,[l.map(((e,a)=>{return s(i("el-tag"),{style:{marginLeft:"2px"},key:`${a}_${e}`},"function"==typeof(l=e)||"[object Object]"===Object.prototype.toString.call(l)&&!S(l)?e:{default:()=>[e]});var l}))]):"-"}},{prop:"description",label:"描述",minWidth:120},{prop:"crateTimeLabel",label:"创建时间",minWidth:140}],operator:[{show:{key:"status",val:[q.DRAFT,q.DEPRECATED]},render:(e,a)=>s("span",{onClick:()=>(e=>{E.confirm("此操作将会删除该数据，是否继续?","Warning",{confirmButtonText:"OK",cancelButtonText:"Cancel",type:"warning"}).then((async()=>{await O(e.id),M({type:"success",message:"Delete completed"}),ge("search")})).catch((()=>{M({type:"info",message:"Delete canceled"}),ge()}))})(a)},[d("删除")])},{render:(e,a)=>s("span",{onClick:()=>{B.value=a,ae.isShowModal=!0,ae.modal={isEdit:!0,description:a.description,code:a.code,name:a.name,dictionaryValue:a.dictionaryValue,schema:a.schema}}},[d("编辑")])},{show:{key:"status",val:[q.DRAFT]},render:(e,a)=>s("span",{onClick:()=>{B.value=a,oe.isShowModal=!0,oe.modal={version:a.version,logs:"新版本",code:a.code,versionType:"patch",schema:a.schema}}},[d("发布")])},{render:(e,a)=>s("span",{onClick:()=>{te.isShowModal=!0,te.modal.query.version="",te.modal.query.code=a.code,be()}},[d("历史版本")])}],operatorConfig:{fixed:"right",align:"center",width:"160",label:"操作"}},listTypeInfo:{orderStatus:_,orderType:T}}),pe=n((()=>({code:{label:"编码",comp:"el-input"},name:{label:"名称",comp:"el-input"}}))),he=e=>{ue.query={...ue.query,...e},ge("search")};m((()=>{ge(),C("OAUTH-USER-LOGIN-CONFIG").then((e=>{}))}));const ge=async e=>{"search"==e&&(ue.table.currentPage=1);const a=await k({page:ue.table.currentPage,pageSize:ue.table.pageSize,code:ue.query.code,name:ue.query.name});ue.table.total=a.data&&a.data.count||0,ue.table.data=a.data&&a.data.data?a.data.data:[],ue.table.data.forEach(((e,a)=>{e.crateTimeLabel=c(e.crateTime).format("YYYY-MM-DD HH:mm"),e.index=a,e.description=e.description||"-"}));const l=Math.ceil(ue.table.total/ue.table.pageSize);return l<ue.table.currentPage&&0!==ue.table.total?(ue.table.currentPage=l,ge()):0===ue.table.total&&(ue.table.currentPage=1),!1},be=async e=>{"search"==e&&(te.modal.table.currentPage=1);const a=await P({page:te.modal.table.currentPage,pageSize:te.modal.table.pageSize,version:te.modal.query.version,code:te.modal.query.code});te.modal.table.total=a.data&&a.data.count||0,te.modal.table.data=a.data&&a.data.data?a.data.data:[],te.modal.table.data.forEach(((e,a)=>{e.crateTimeLabel=c(e.crateTime).format("YYYY-MM-DD HH:mm"),e.index=a,e.description=e.description||"-"}));const l=Math.ceil(te.modal.table.total/te.modal.table.pageSize);return l<te.modal.table.currentPage&&0!==te.modal.table.total?(te.modal.table.currentPage=l,be()):0===te.modal.table.total&&(te.modal.table.currentPage=1),!1},ye=()=>{te.modal.table.currentPage=1,te.modal.table.pageSize=50,te.modal.table.total=0,te.modal.table.data=[],te.modal.query={version:"",code:""}},fe=e=>{ue.table.pageSize=e,ge()},we=e=>{te.modal.table.pageSize=e,be()},ve=e=>{te.modal.table.currentPage=e,be()},Se=e=>{ue.table.currentPage=e,ge()},Me=()=>{V((async()=>{await(async()=>{var e,a,l,o;try{if((null==(e=B.value)?void 0:e.schema)||le.modal.schema){const e=le.modal.schema?JSON.parse(le.modal.schema):JSON.parse(null==(a=B.value)?void 0:a.schema);await(null==(o=(l=H.value).setSchema)?void 0:o.call(l,e))}}catch(t){}})()}))};return(e,a)=>{const l=i("t-query-condition"),o=i("t-layout-page-item"),t=i("el-button"),r=i("t-table"),n=i("el-link"),m=i("el-alert"),c=i("el-input"),S=i("el-form-item"),M=i("vue-monaco-editor"),E=i("el-form"),V=i("el-drawer"),_=i("el-option"),T=i("el-select"),x=i("el-dialog"),q=i("t-layout-page");return u(),p(q,null,{default:h((()=>[s(o,null,{default:h((()=>[s(l,{boolEnter:!1,opts:g(pe),onSubmit:he},null,8,["opts"])])),_:1}),s(o,null,{default:h((()=>[s(r,{title:"模板管理",table:g(ue).table,columns:g(ue).table.columns,onSizeChange:fe,onPageChange:ve},{toolbar:h((()=>[b("div",null,[s(t,{type:"primary",onClick:Q},{default:h((()=>a[11]||(a[11]=[d("新增")]))),_:1})])])),_:1},8,["table","columns"])])),_:1}),s(V,{"destroy-on-close":"",class:"custom-class-message-info-dialog",top:"100px",modelValue:g(ae).isShowModal,"onUpdate:modelValue":a[4]||(a[4]=e=>g(ae).isShowModal=e),title:"新增模板",size:"660px"},{footer:h((()=>[b("span",A,[s(t,{onClick:re},{default:h((()=>a[14]||(a[14]=[d("取消")]))),_:1}),s(t,{type:"primary",onClick:de},{default:h((()=>a[15]||(a[15]=[d(" 确认 ")]))),_:1})])])),default:h((()=>[s(m,{type:"warning",closable:!1},{title:h((()=>[a[13]||(a[13]=b("span",{style:{"margin-right":"8px"}},"Schema 配置数据可通过表单设计功能得到",-1)),s(n,{type:"primary",href:g(F),target:"_blank"},{default:h((()=>a[12]||(a[12]=[d("设计表单")]))),_:1},8,["href"])])),_:1}),s(E,{"label-position":"top",ref_key:"form",ref:I,"label-width":"60px",rules:g(X),model:g(ae).modal,class:"demo-form-inline"},{default:h((()=>[s(S,{"label-width":"120",required:"",label:"名称",prop:"name"},{default:h((()=>[s(c,{modelValue:g(ae).modal.name,"onUpdate:modelValue":a[0]||(a[0]=e=>g(ae).modal.name=e),disabled:g(ae).modal.isEdit,max:"10",style:{width:"100%"}},null,8,["modelValue","disabled"])])),_:1}),s(S,{"label-width":"120",required:"",label:"编码",prop:"code"},{default:h((()=>[s(c,{modelValue:g(ae).modal.code,"onUpdate:modelValue":a[1]||(a[1]=e=>g(ae).modal.code=e),disabled:g(ae).modal.isEdit,max:"10",style:{width:"100%"}},null,8,["modelValue","disabled"])])),_:1}),s(S,{"label-width":"120",label:"描述",prop:"description"},{default:h((()=>[s(c,{"show-word-limit":!0,type:"textarea",modelValue:g(ae).modal.description,"onUpdate:modelValue":a[2]||(a[2]=e=>g(ae).modal.description=e),max:"250",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),s(S,{"label-width":"120",required:"",label:"schema配置",prop:"schema"},{default:h((()=>[b("div",R,[s(M,{value:g(ae).modal.schema,"onUpdate:value":a[3]||(a[3]=e=>g(ae).modal.schema=e),theme:"vs-dark",language:"json",options:N,onMount:J},null,8,["value"])])])),_:1})])),_:1},8,["rules","model"])])),_:1},8,["modelValue"]),s(V,{"destroy-on-close":"",class:"custom-class-message-info-dialog",top:"100px",modelValue:g(oe).isShowModal,"onUpdate:modelValue":a[8]||(a[8]=e=>g(oe).isShowModal=e),title:"发布版本",size:"540px"},{footer:h((()=>[b("span",$,[s(t,{onClick:se},{default:h((()=>a[18]||(a[18]=[d("取消")]))),_:1}),s(t,{type:"primary",onClick:ie},{default:h((()=>a[19]||(a[19]=[d(" 确认 ")]))),_:1})])])),default:h((()=>[s(m,{type:"warning",closable:!1},{title:h((()=>[a[17]||(a[17]=b("span",{style:{"margin-right":"8px"}},"请做好版本发布前的检查",-1)),s(n,{type:"primary",onClick:ne},{default:h((()=>a[16]||(a[16]=[d("预览模板")]))),_:1})])),_:1}),s(E,{"label-position":"top",ref_key:"form",ref:I,"label-width":"60px",rules:g(ee),model:g(oe).modal,class:"demo-form-inline"},{default:h((()=>[s(S,{"label-width":"120",required:"",label:"版本",prop:"versionType"},{default:h((()=>[s(T,{modelValue:g(oe).modal.versionType,"onUpdate:modelValue":a[5]||(a[5]=e=>g(oe).modal.versionType=e)},{default:h((()=>[(u(!0),y(f,null,w(g(z)(g(oe).modal.version),(e=>(u(),p(_,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),s(S,{"label-width":"120",label:"发布日志",prop:"logs"},{default:h((()=>[s(c,{"show-word-limit":!0,type:"textarea",modelValue:g(oe).modal.logs,"onUpdate:modelValue":a[6]||(a[6]=e=>g(oe).modal.logs=e),max:"250",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),s(S,{"label-width":"120",required:"",label:"schema配置",prop:"schema"},{default:h((()=>[b("div",Y,[s(M,{value:g(oe).modal.schema,"onUpdate:value":a[7]||(a[7]=e=>g(oe).modal.schema=e),theme:"vs-dark",language:"json",options:W,onMount:K},null,8,["value"])])])),_:1})])),_:1},8,["rules","model"])])),_:1},8,["modelValue"]),s(x,{modelValue:g(le).isShowModal,"onUpdate:modelValue":a[9]||(a[9]=e=>g(le).isShowModal=e),title:"预览",onClose:ce,width:"70%",fullscreen:"",class:"publish-template-preview-render-dialog"},{default:h((()=>[g(le).isShowModal?(u(),p(L,{key:0,ref_key:"schemaRenderRef",ref:H,onMounted:Me},null,512)):v("",!0)])),_:1},8,["modelValue"]),s(V,{"destroy-on-close":"",class:"custom-class-message-info-dialog",top:"100px",modelValue:g(te).isShowModal,"onUpdate:modelValue":a[10]||(a[10]=e=>g(te).isShowModal=e),title:"历史版本",size:"640px",onClose:ye},{default:h((()=>[s(r,{title:"",table:g(te).modal.table,columns:g(te).modal.table.columns,onSizeChange:we,onPageChange:Se},null,8,["table","columns"])])),_:1},8,["modelValue"])])),_:1})}}});export{H as default};
