import{d as e,f as a,ah as t,C as l,a as o,M as s,q as r,i as n,t as i,o as d,ai as u,F as c,j as p,n as m,w as g,m as h,N as f,l as b,U as y,Z as w,H as v,V,aj as _,y as L,X as I,af as k,ak as x,I as C,al as M,_ as T}from"./index-455b6c01.js";import{i as q}from"./version-078b84e2.js";const P={class:"text-large font-600 mr-3"},S={class:"dialog-footer"},$={class:"dialog-footer"},E={class:"dialog-footer"},W={class:"dialog-footer"};const z=T(e({...e({name:"pageManageVersionList"}),setup(e){const T=a();let{proxy:z}=v();const D=t(),Y=l((()=>z.$route.query.name)),j=o({show:!1,schemaInfo:{}});s(D,(e=>{e&&ee("search")}));const H=e=>{B.table.pageSize=e,ee()},N=e=>{B.table.currentPage=e,ee()},U=async()=>{V();try{const e=q(B.table.data[0].version,"patch"),a=await k(z.$route.query.id,e);a.success?(ee("search"),L({type:"success",message:"操作成功"})):L({type:"error",message:a.message||a.errorMessage||"系统错误"})}catch(e){L({type:"error",message:e.message||e.errorMessage||"系统错误"})}I()},O=e=>{Z.show=!1,Z.row=null},G=e=>{F.show=!1,F.row=null},J=async()=>{V();try{const e=await M(z.$route.query.id,X.row.id);X.show=!1,e.success?(ee("search"),L({type:"success",message:"操作成功"})):L({type:"error",message:e.errorMessage||"系统错误"})}catch(e){L({type:"error",message:"系统错误"})}I()},R=e=>{A.show=!1,A.row=null},B=o({query:{id:z.$route.query.id,committer:"",version:"",status:"",env:""},table:{total:0,pageSize:10,currentPage:1,data:[],columns:[{prop:"id",label:"Id",width:80,render:(e,a)=>e||"--"},{prop:"version",label:"版本",minWidth:120,render:(e,a)=>{return r(n("el-button"),{disabled:!0!==(null==a?void 0:a.operateEditPageMeta),type:"text",onClick:()=>(async e=>{var a;V();try{const t=await _(e.id);t.success?(j.show=!0,j.schemaInfo=(null==(a=null==t?void 0:t.data)?void 0:a.pageSchema)||{}):L({type:"error",message:t.message||"系统错误"})}catch(t){L({type:"error",message:"系统错误"})}I()})(a)},"function"==typeof(t=e)||"[object Object]"===Object.prototype.toString.call(t)&&!w(t)?e:{default:()=>[e]});var t}},{prop:"committer",label:"操作者",minWidth:120,render:(e,a)=>e||"--"},{prop:"name",label:"页面信息",minWidth:120,render:(e,a)=>r("div",null,[r(n("el-button"),{disabled:!0!==(null==a?void 0:a.operateEditPageMeta),type:"primary",link:!0,onClick:()=>{T.push({path:"/atomManagement/pageManage/info",query:{id:z.$route.query.id,name:z.$route.query.name}})}},{default:()=>[z.$route.query.name]})])},{prop:"status",label:"版本状态",minWidth:120,render:(e,a)=>{const t={"-2":"danger","-1":"info",0:"primary",1:"success"}[null==a?void 0:a.status]||"info";return r(n("el-tag"),{effect:"light",type:t},{default:()=>[a.statusName]})}},{prop:"env",label:"发布状态",render:(e,a)=>{const t={EDIT_ING:"info",TEST:"primary",PROD:"success"}[null==a?void 0:a.env]||"info";return-1===a.status?r(n("el-tag"),{effect:"light",type:"info"},{default:()=>[i("已下线")]}):r(n("el-tag"),{effect:"light",type:t},{default:()=>[a.envName]})}},{prop:"updateTimeLabel",label:"最后更新时间",minWidth:140}],operator:[{text:"装修",fun:e=>{window.open(`${x}/lowcode-platform/#/editor?pageId=${e.pageId}&pageVersionId=${e.id}&pageName=${Y.value}&token=${C()}`)},show:{key:"operateEditVersion",val:[!0]}},{text:"复制为新草稿",fun:e=>{X.row=e,X.show=!0},show:{key:"operateCopyVersion",val:[!0]}},{text:"发布记录",fun:e=>{T.push({path:"/atomManagement/pageManage/pagePublishLog",query:{id:e.id,name:z.$route.query.name,pageId:e.pageId}})},show:{key:"operateLogVersion",val:[!0]}}],operatorConfig:{fixed:"right",align:"center",width:"180",label:"操作"}},listTypeInfo:{pageStatusList:[{dictLabel:"新创建",dictValue:0},{dictLabel:"已发布",dictValue:1},{dictLabel:"已下线",dictValue:-1},{dictLabel:"已删除",dictValue:-2}],sceneTypeList:[{dictLabel:"PC",dictValue:"pc"},{dictLabel:"H5",dictValue:"h5"}],envList:[{dictLabel:"测试环境",dictValue:"TEST"},{dictLabel:"生成环境",dictValue:"PROD"},{dictLabel:"编辑中",dictValue:"EDIT_ING"}]}}),F=o({show:!1,row:null}),X=o({show:!1,row:null}),Z=o({show:!1,row:null}),A=o({show:!1,row:null}),K=l((()=>({version:{label:"版本",comp:"el-input",bind:{clearable:!0}},committer:{label:"操作者",comp:"el-input",bind:{clearable:!0}},status:{label:"版本状态",comp:"el-select",changeEvent:"change",type:"select-arr",list:"pageStatusList",listTypeInfo:B.listTypeInfo,bind:{clearable:!0}},env:{label:"发布环境",comp:"el-select",changeEvent:"change",type:"select-arr",list:"envList",listTypeInfo:B.listTypeInfo}}))),Q=e=>{B.query={...B.query,...e},ee("search")};d((()=>{ee()}));const ee=async e=>{"search"==e&&(B.table.currentPage=1);const a=await u({...B.query,page:B.table.currentPage,pageSize:B.table.pageSize});B.table.total=a.data&&a.data.count||0,B.table.data=a.data&&a.data.data?a.data.data:[],B.table.data.forEach((e=>{var a,t,l,o;e.updateTimeLabel=c(e.updateTime).format("YYYY-MM-DD HH:mm"),e.updateTimeLabel=c(e.updateTime).format("YYYY-MM-DD HH:mm"),e.operateEditVersion=!0===(null==(a=e.operate)?void 0:a.editVersion),e.operateCopyVersion=!0===(null==(t=e.operate)?void 0:t.copyVersion),e.operateLogVersion=!0===(null==(l=e.operate)?void 0:l.logVersion)&&1===e.status,e.operateEditPageMeta=!0===(null==(o=e.operate)?void 0:o.editMeta)}));const t=Math.ceil(B.table.total/B.table.pageSize);return t<B.table.currentPage&&0!==B.table.total?(B.table.currentPage=t,ee()):0===B.table.total&&(B.table.currentPage=1),!1};return(e,a)=>{const t=n("el-page-header"),l=n("t-query-condition"),o=n("t-layout-page-item"),s=n("el-button"),d=n("el-popconfirm"),u=n("t-table"),c=n("el-dialog"),w=n("JsonViewer"),v=n("el-scrollbar"),V=n("el-drawer"),_=n("t-layout-page");return p(),m(_,{class:"page_manage_container"},{default:g((()=>[r(o,null,{default:g((()=>[r(t,{onBack:a[0]||(a[0]=()=>h(f)(h(T)))},{content:g((()=>a[10]||(a[10]=[b("span",{class:"text-large font-600 mr-3"}," 版本列表 ",-1)]))),_:1}),r(l,{opts:K.value,onSubmit:Q},null,8,["opts"])])),_:1}),r(o,null,{default:g((()=>[r(u,{table:h(B).table,columns:h(B).table.columns,onSizeChange:H,onPageChange:N},{toolbar:g((()=>[r(d,{width:"180","confirm-button-text":"确定","cancel-button-text":"取消",title:"确定要新建一个版本?",onConfirm:U},{reference:g((()=>[r(s,{type:"primary"},{default:g((()=>a[11]||(a[11]=[i("新建版本")]))),_:1})])),_:1})])),title:g((()=>[b("span",P,y(Y.value),1)])),_:1},8,["table","columns"]),r(c,{size:"small",modelValue:h(F).show,"onUpdate:modelValue":a[2]||(a[2]=e=>h(F).show=e),"align-center":"",title:"Warning",width:"500px"},{footer:g((()=>[b("div",S,[r(s,{onClick:a[1]||(a[1]=e=>h(F).show=!1)},{default:g((()=>a[12]||(a[12]=[i("取消")]))),_:1}),r(s,{type:"primary",onClick:G},{default:g((()=>a[13]||(a[13]=[i(" 确认 ")]))),_:1})])])),default:g((()=>[a[14]||(a[14]=b("span",null,"确定要删除该页面？",-1))])),_:1},8,["modelValue"]),r(c,{modelValue:h(Z).show,"onUpdate:modelValue":a[4]||(a[4]=e=>h(Z).show=e),"align-center":"",title:"Warning",width:"500px"},{footer:g((()=>[b("div",$,[r(s,{onClick:a[3]||(a[3]=e=>h(Z).show=!1)},{default:g((()=>a[15]||(a[15]=[i("取消")]))),_:1}),r(s,{type:"primary",onClick:O},{default:g((()=>a[16]||(a[16]=[i(" 确认 ")]))),_:1})])])),default:g((()=>[a[17]||(a[17]=b("span",null,"确定要下线该页面？",-1))])),_:1},8,["modelValue"]),r(c,{modelValue:h(A).show,"onUpdate:modelValue":a[6]||(a[6]=e=>h(A).show=e),"align-center":"",title:"Warning",width:"500px"},{footer:g((()=>[b("div",E,[r(s,{onClick:a[5]||(a[5]=e=>h(A).show=!1)},{default:g((()=>a[18]||(a[18]=[i("取消")]))),_:1}),r(s,{type:"primary",onClick:R},{default:g((()=>a[19]||(a[19]=[i(" 确认 ")]))),_:1})])])),default:g((()=>[a[20]||(a[20]=b("span",null,"确定要回滚导改版本？",-1))])),_:1},8,["modelValue"]),r(c,{size:"small",modelValue:h(X).show,"onUpdate:modelValue":a[8]||(a[8]=e=>h(X).show=e),"align-center":"",title:"Warning",width:"500px"},{footer:g((()=>[b("div",W,[r(s,{onClick:a[7]||(a[7]=e=>h(X).show=!1)},{default:g((()=>a[21]||(a[21]=[i("取消")]))),_:1}),r(s,{type:"primary",onClick:J},{default:g((()=>a[22]||(a[22]=[i(" 确认 ")]))),_:1})])])),default:g((()=>[a[23]||(a[23]=b("span",null,"确定要将该页面复制为新草稿版本？",-1))])),_:1},8,["modelValue"])])),_:1}),r(V,{"append-to-body":!0,"with-header":!1,modelValue:h(j).show,"onUpdate:modelValue":a[9]||(a[9]=e=>h(j).show=e),title:Y.value},{default:g((()=>[r(v,null,{default:g((()=>[r(w,{expanded:!0,value:h(j).schemaInfo,copyable:"",boxed:"",sort:"",theme:"dark"},null,8,["value"])])),_:1})])),_:1},8,["modelValue","title"])])),_:1})}}}),[["__scopeId","data-v-c95db710"]]);export{z as default};
