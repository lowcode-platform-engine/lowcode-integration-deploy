var O=Object.defineProperty;var L=(r,t,e)=>t in r?O(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var R=(r,t,e)=>L(r,typeof t!="symbol"?t+"":t,e);import{an as f,h as F}from"./index-CJyGQGl4.js";import{E as A,d as b,e as _,f as D,h as $,j as U,k as v,S,l as y,A as E}from"./storage-C2-tuK8u.js";class k{constructor(){this._events={}}on(t,e,n){t=t.trim(),this._events[t]||(this._events[t]=[]),this._events[t].push({callback:e,once:!!n})}off(t,e){if(t||(this._events={}),!e)delete this._events[t];else{const n=this._events[t]||[];let{length:o}=n;for(let s=0;s<o;s++)n[s].callback===e&&(n.splice(s,1),o--,s--);n.length===0&&delete this._events[t]}}emit(t,e){const n=this._events[t]||[];(s=>{let{length:i}=s;for(let a=0;a<i;a++){if(!s[a])continue;const{callback:c,once:d}=s[a];d&&(s.splice(a,1),s.length===0&&delete this._events[t],i--,a--),c.apply(this,[e])}})(n)}getEvents(){return this._events}}var x,z=new Uint8Array(16);function G(){if(!x&&(x=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!x))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return x(z)}const J=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Q(r){return typeof r=="string"&&J.test(r)}var g=[];for(var w=0;w<256;++w)g.push((w+256).toString(16).substr(1));function q(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(g[r[t+0]]+g[r[t+1]]+g[r[t+2]]+g[r[t+3]]+"-"+g[r[t+4]]+g[r[t+5]]+"-"+g[r[t+6]]+g[r[t+7]]+"-"+g[r[t+8]]+g[r[t+9]]+"-"+g[r[t+10]]+g[r[t+11]]+g[r[t+12]]+g[r[t+13]]+g[r[t+14]]+g[r[t+15]]).toLowerCase();if(!Q(e))throw TypeError("Stringified UUID is invalid");return e}function N(r,t,e){r=r||{};var n=r.random||(r.rng||G)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,q(n)}const W=()=>`exec-${N()}`,B=()=>`action-${N()}`,X=()=>`engine-${N()}`;class H extends k{constructor(t){super(),this.nodeQueueMap=new Map,this.actionRunningMap=new Map,this.flowModel=t.flowModel,this.recorder=t.recorder}addAction(t){const{executionId:e}=t;this.nodeQueueMap.has(e)||this.nodeQueueMap.set(e,[]);const n=this.nodeQueueMap.get(e);n&&n.push(t),console.log("this.nodeQueueMap--->>>",this.nodeQueueMap)}pushActionToRunningMap(t){var e;const{executionId:n,actionId:o}=t;if(!this.actionRunningMap.has(n)){const s=new Map;this.actionRunningMap.set(n,s)}o&&((e=this.actionRunningMap.get(n))===null||e===void 0||e.set(o,t))}removeActionFromRunningMap(t){const{executionId:e,actionId:n}=t;if(!n)return;const o=this.actionRunningMap.get(e);o&&o.delete(n)}saveActionResult(t){var e;(e=this.recorder)===null||e===void 0||e.addActionRecord(Object.assign({timestamp:Date.now()},t))}hasRunningAction(t){const e=this.actionRunningMap.get(t);return e?e.size===0?(this.actionRunningMap.delete(t),!1):!0:!1}run(t){const e=this.nodeQueueMap.get(t.executionId);for(;e!=null&&e.length;){const n=e.pop(),o=B(),s=Object.assign(Object.assign({},n),{actionId:o});this.pushActionToRunningMap(s),this.exec(s)}this.hasRunningAction(t.executionId)||this.emit(A,Object.assign(Object.assign({},t),{status:b.COMPLETED}))}next(t){t.outgoing&&t.outgoing.length>0&&t.outgoing.forEach(e=>{e.result&&this.addAction({executionId:t.executionId,nodeId:e.target})}),this.saveActionResult(t),this.removeActionFromRunningMap(t),this.run(t)}resume(t){return f(this,void 0,void 0,function*(){const{executionId:e,actionId:n,nodeId:o}=t;this.pushActionToRunningMap({executionId:e,actionId:n,nodeId:o});const s=this.flowModel.createAction(o);yield s==null?void 0:s.resume(Object.assign(Object.assign({},t),{next:this.next.bind(this)}))})}interrupted(t){this.emit(_,t)}error(t){this.emit(D,t)}exec(t){return f(this,void 0,void 0,function*(){const{executionId:e,actionId:n,nodeId:o}=t,s=this.flowModel.createAction(o),i=yield s==null?void 0:s.execute({executionId:e,actionId:n,nodeId:o,next:this.next.bind(this)});if(i){const{nodeType:a,properties:c,outgoing:d,status:l,detail:h}=i,u={executionId:e,actionId:n,nodeId:o,nodeType:a,properties:c,outgoing:d,status:l,detail:h};(i==null?void 0:i.status)===b.INTERRUPTED&&(this.interrupted(i),this.saveActionResult(u),this.removeActionFromRunningMap(t)),(i==null?void 0:i.status)===b.ERROR&&(this.error(i),this.saveActionResult(u),this.removeActionFromRunningMap(t))}})}}class Y{constructor({nodeModelMap:t,recorder:e,context:n={},globalData:o={},startNodeType:s="StartNode"}){this.nodeConfigMap=new Map,this.startNodes=[],this.globalData={},this.nodeModelMap=t,this.executeList=[],this.executingInstance=null,this.context=n,this.globalData=o,this.startNodeType=s,this.isRunning=!1,this.scheduler=new H({flowModel:this,recorder:e}),this.scheduler.on(A,i=>{this.onExecuteFinished(i)}),this.scheduler.on(_,i=>{this.onExecuteFinished(i)}),this.scheduler.on(D,i=>{this.onExecuteFinished(i)})}load(t){const{nodes:e=[],edges:n=[]}=t;e.forEach(o=>{if(this.nodeModelMap.has(o.type)){const s={id:o.id,type:o.type,properties:o.properties,incoming:[],outgoing:[]};this.nodeConfigMap.set(o.id,s),o.type===this.startNodeType&&this.startNodes.push(s)}else console.warn(`未识别的节点类型：${o.type}`)}),n.forEach(o=>{const s=this.nodeConfigMap.get(o.sourceNodeId),i=this.nodeConfigMap.get(o.targetNodeId);s&&s.outgoing.push({id:o.id,properties:o.properties,target:o.targetNodeId}),i&&i.type!==this.startNodeType&&i.incoming.push({id:o.id,properties:o.properties,source:o.sourceNodeId})})}createExecution(t){var e;if(this.executeList.push(t),t.actionId&&t.nodeId&&t.executionId){this.scheduler.resume({executionId:t.executionId,actionId:t.actionId,nodeId:t.nodeId,data:t.data});return}const n=W();if(t.executionId=n,t!=null&&t.nodeId){const o=this.nodeConfigMap.get(t.nodeId);if(!o){(e=t==null?void 0:t.onError)===null||e===void 0||e.call(t,new Error(`${$(U.NONE_NODE_ID)}(${t.nodeId})`));return}this.startNodes=[o]}this.startNodes.forEach(o=>{this.scheduler.addAction({executionId:n,nodeId:o.id})}),this.scheduler.run({executionId:n})}execute(t){return f(this,void 0,void 0,function*(){this.createExecution(t)})}resume(t){return f(this,void 0,void 0,function*(){this.createExecution(t)})}createAction(t){const e=this.nodeConfigMap.get(t);if(e){const n=this.nodeModelMap.get(e.type);if(!n)throw new Error("该 NodeModel 不存在，抛出异常");return new n({nodeConfig:e,globalData:this.globalData,context:this.context})}}setStartNodeType(t){this.startNodeType=t}updateGlobalData(t){return this.globalData=Object.assign(Object.assign({},this.globalData),t),this.globalData}onExecuteFinished(t){const e=this.executeList.findIndex(n=>n.executionId===t.executionId);if(e>-1){const{callback:n}=this.executeList[e];this.executeList.splice(e,1),n==null||n(t)}}}const Z=100,P=100,C="LOGICFLOW_ENGINE_INSTANCES";class K{constructor({instanceId:t}){this.instanceId=t,this.maxRecorder=Z;const e=this.getItem(C)||[];if(e.indexOf(t)===-1&&e.push(t),e.length>P){const n=e.shift();this.clearInstance(n)}this.setItem(C,e)}setMaxRecorderNumber(t){this.maxRecorder=t}setItem(t,e){try{v.setItem(t,e)}catch{console.error("Ops, something wrong with storage.setItem !!!"),v.clear(),v.setItem(t,e)}}getItem(t){return v.getItem(t)}getExecutionActions(t){return f(this,void 0,void 0,function*(){return this.getItem(t)})}getExecutionList(){return f(this,void 0,void 0,function*(){return this.getItem(this.instanceId)||[]})}addExecution(t){const e=this.getItem(this.instanceId)||[];if(e.length>=this.maxRecorder){const n=e.shift();this.popExecution(n)}e.push(t),this.setItem(this.instanceId,e)}popExecution(t){(this.getItem(t)||[]).forEach(n=>{v.removeItem(n)}),v.removeItem(t)}pushActionToExecution(t,e){const n=this.getItem(t)||[];n.push(e),this.setItem(t,n)}addActionRecord(t){return f(this,void 0,void 0,function*(){const{executionId:e,actionId:n}=t;(yield this.getExecutionActions(e))||this.addExecution(e),this.pushActionToExecution(e,n),this.setItem(n,t)})}getActionRecord(t){return f(this,void 0,void 0,function*(){return this.getItem(t)})}clear(){this.clearInstance(this.instanceId)}clearInstance(t){(this.getItem(t)||[]).forEach(n=>{v.removeItem(n),(this.getItem(n)||[]).forEach(s=>{v.removeItem(s)})}),v.removeItem(t)}}class j{constructor(t){this.nodeModelMap=new Map,this.instanceId=X(),t!=null&&t.debug&&(this.recorder=new K({instanceId:this.instanceId})),this.register({type:S.nodeTypeName,model:S}),this.register({type:y.nodeTypeName,model:y}),this.context=(t==null?void 0:t.context)||{}}register(t){this.nodeModelMap.set(t.type,t.model)}setCustomRecorder(t){this.recorder=t}load({graphData:t,startNodeType:e="StartNode",globalData:n={}}){this.graphData=t;const o=new Y({nodeModelMap:this.nodeModelMap,recorder:this.recorder,context:this.context,globalData:n,startNodeType:e});return o.load(t),this.flowModel=o,o}execute(t){return f(this,void 0,void 0,function*(){return new Promise((e,n)=>{var o;let s=t;t||(s={}),(o=this.flowModel)===null||o===void 0||o.execute(Object.assign(Object.assign({},s),{callback:i=>{e(i)},onError:i=>{n(i)}}))})})}resume(t){return f(this,void 0,void 0,function*(){return new Promise((e,n)=>{var o;(o=this.flowModel)===null||o===void 0||o.resume(Object.assign(Object.assign({},t),{callback:s=>{e(s)},onError:s=>{n(s)}}))})})}getExecutionList(){return f(this,void 0,void 0,function*(){var t;return yield(t=this.recorder)===null||t===void 0?void 0:t.getExecutionList()})}getExecutionRecord(t){return f(this,void 0,void 0,function*(){var e,n;const o=yield(e=this.recorder)===null||e===void 0?void 0:e.getExecutionActions(t);if(!o)return null;const s=[];for(let i=0;i<(o==null?void 0:o.length);i++){const a=o[i];this.recorder&&s.push((n=this.recorder)===null||n===void 0?void 0:n.getActionRecord(a))}return Promise.all(s)})}destroy(){var t;(t=this.recorder)===null||t===void 0||t.clear()}getGlobalData(){var t;return(t=this.flowModel)===null||t===void 0?void 0:t.globalData}setGlobalData(t){this.flowModel&&(this.flowModel.globalData=t)}updateGlobalData(t){this.flowModel&&Object.assign(this.flowModel.globalData,t)}}const V=(r,t,e)=>{switch(e){case"=":case"===":return r===t;case"!=":case"!==":return r!==t;case">":return r>t;case">=":return r>=t;case"<":return r<t;case"<=":return r<=t;default:throw new Error(`Unsupported operator: ${e}`)}},M=(r,t,e,n,o={})=>{var s,i;return r!=null&&r.value&&((s=t==null?void 0:t.isJSExpression)!=null&&s.call(t,r.value))&&r.valueType==="flowRunningTime"?t==null?void 0:t.parseData(r.value,n,o):r!=null&&r.value&&((i=t==null?void 0:t.isJSExpression)!=null&&i.call(t,r.value))?t==null?void 0:t.parseData(r.value,e,o):r.type==="number"?Number(r.value):r.type==="boolean"?r.value==="true"||r.value===!0:r.value},T=(r,t,e)=>{const n=t==null?void 0:t.utils,{relation:o="AND",conditions:s=[],value:i=[]}=r,a=s.map(l=>T(l,t,e)),c=i.map(({operate:l,source:h,target:u})=>{const p=M(h,n,t,e,{thisRequiredInJSE:!0,errCallback:I=>{console.log(I)}}),m=M(u,n,t,e,{thisRequiredInJSE:!0,errCallback:I=>{console.log(I)}});return V(p,m,l)}),d=[...a,...c];if(o==="AND")return d.every(Boolean);if(o==="OR")return d.some(Boolean);throw new Error(`Unknown relation: ${o}`)},tt=(r,t,e)=>{const n=t==null?void 0:t.utils,o=(i,a={})=>{var c,d;return i!=null&&i.value&&((c=n==null?void 0:n.isJSExpression)!=null&&c.call(n,i.value))&&i.valueType==="flowRunningTime"?n==null?void 0:n.parseData(i.value,e,a):i!=null&&i.value&&((d=n==null?void 0:n.isJSExpression)!=null&&d.call(n,i.value))?n==null?void 0:n.parseData(i.value,t,a):i.type==="number"?Number(i.value):i.type==="boolean"?i.value==="true"||i.value===!0:i.value},s=(i,a)=>{var c;console.log("updatePageState"),console.log(i,a),(c=t==null?void 0:t.setState)==null||c.call(t,d=>{const l={...d},h=i.split(".");return h.reduce((u,p,m)=>(m===h.length-1?u[p]=a:u[p]||(u[p]={}),u[p]),l),l})};r.map(({source:i,target:a})=>{var h,u,p,m;const c=i.valueType,d=(m=(p=(u=(h=i.value)==null?void 0:h.value)==null?void 0:u.split(".").slice(2))==null?void 0:p.join)==null?void 0:m.call(p,"."),l=o(a,{thisRequiredInJSE:!0,errCallback:I=>{console.log(I)}});c==="pageState"&&s(d,l)})};function et(r){return Object.entries(r).map(([t,e])=>e==null?"":Array.isArray(e)?e.map(n=>`${t}=${n}`).join("&"):`${t}=${e}`).filter(Boolean).join("&")}class nt extends y{parseData(t){const e={};return t.forEach(n=>{const o=n.value.valueType,s=n.value.type;if(o==="input"){let i=n.value.value;s==="number"&&(i=Number(i)),s==="boolean"&&(i=[!0,"true"].includes(i)),e[n.key]=i}else e[n.key]=n.value.value}),e}async fetchDataSource(){console.log(this.context),console.log(this);const e=(this.properties||{}).biz||{},{value:n={},onFailureConfig:o={}}=e,{continueOnFailure:s}=o,{bodyList:i=[],paramsList:a=[],requestMethod:c="GET",requestUrl:d=""}=n;return new Promise(async(l,h)=>{try{const u=await this.context.pageInstance.utils.request({method:c.toLowerCase(),url:d,data:this.parseData(i),params:this.parseData(a)});l({continueOnFailure:s,bodyList:i,res:u,paramsList:a,requestMethod:c})}catch(u){h(u)}})}async pageJump(){return new Promise(async(t,e)=>{const s=((this.properties||{}).biz||{value:{}}).value;try{const a=(d=>{const l={},h=this.context.pageInstance;return d.forEach(u=>{l[u.key]=M(u.value,h.utils,h,this,{thisRequiredInJSE:!0,errCallback:p=>{console.log(p)}})}),l})(s.routeParams||[]),c=et(a);s.target==="_blank"&&s.path&&window.open(`${s.path}?${c}`,"_blank"),s.target==="_self"&&s.path&&(window.location.href=`${s.path}?${c}`),t(!0)}catch(i){e(i)}})}async action(){var t,e,n,o;try{console.log("runner:CommonNode",this);const s=(t=this.properties)==null?void 0:t.value;let i;if(s==="DataSource"&&(i=await this.fetchDataSource()),s==="PageJump"&&(await this.pageJump(),i=!0),s==="Condition"){const a=await this.getConditionIsPass();console.log("执行action",a),i=a}return s==="UpdateState"&&(i=await this.updateState()),this.globalData.actionResponse=i,{detail:i,status:E.SUCCESS}}catch(s){const i=(o=(n=(e=this.properties)==null?void 0:e.biz)==null?void 0:n.onFailureConfig)==null?void 0:o.continueOnFailure;return console.log(s),i?{detail:s,status:E.SUCCESS}:{detail:s,status:E.ERROR}}}runConditions(t){try{const e=this.context.pageInstance;return T(t,e,this)}catch(e){return console.log(e),!1}}async getConditionIsPass(){if(!this.properties)return!0;const{biz:t}=this.properties||{};try{const e=t.value;return this.runConditions(e)}catch{return!1}}async updateState(){if(!this.properties)return!0;const{biz:t}=this.properties||{};try{const e=t.value,n=this.context.pageInstance;return console.log("updateState",e),tt(e,n,this),!0}catch{return!1}}async isPass(t){if(!this.properties)return!0;const{value:e}=this.properties||{};return e==="Condition"?this.globalData.actionResponse!==void 0&&typeof this.globalData.actionResponse=="boolean"?this.globalData.actionResponse:(this.globalData.actionResponse=await this.getConditionIsPass(),this.globalData.actionResponse):!0}}class ot extends y{async action(){return console.log("runner:StartNode",this),{status:E.SUCCESS,detail:{}}}}class it extends y{async action(){return console.log("runner:ComponentNode",this),{status:E.SUCCESS,detail:{}}}}class st{constructor(){R(this,"nodes",[{type:"CommonNode",model:nt,x:0,y:0},{type:"StartNode",model:ot,x:0,y:0},{type:"ComponentNode",model:it,x:0,y:0}]);R(this,"snapshootWindow",window)}registerWindow(t){this.snapshootWindow=t}registerNode(t){const e=this.nodes.concat(t);this.nodes=e.reduce((n,o)=>n.find(i=>i.type===o.type)?n:n.concat([o]),[])}async execute(t,e){var i,a;console.log("runner:开始执行",t);const n=new j({context:e,debug:!0});this.nodes.forEach(c=>{n.register({type:c.type,model:c.model})}),n.load({graphData:t,globalData:{},startNodeType:((a=(i=t==null?void 0:t.nodes)==null?void 0:i[0])==null?void 0:a.type)||"StartNode"});const o=await n.execute();console.log("runner:",o);const s=await n.getExecutionRecord(o.executionId);console.log(s),n.destroy()}getRenderSchema(){return this.snapshootWindow.__RENDER_PAGE_STATE__}async executeLifeCycle(t,e,n,o){var c,d;const i=this.getRenderSchema().flows||[],a=((d=(c=e==null?void 0:e.lifeCycles)==null?void 0:c[t])==null?void 0:d.flowIdList)||[];if(a&&(a!=null&&a.length)){console.log("runner,flowIdList:",a);for(let l=0;l<a.length;l++){const h=a[l],u=i.find(p=>p.code===h);u&&await this.execute(u.data,{pageInstance:n,schema:e,args:o})}}}async executeFunction(t,e,n,o){const s=e.schema;if(s){const a=this.getRenderSchema().flows||[],c=F(s.props,t,{}),d=(c==null?void 0:c.flowIdList)||[];if(d&&(d!=null&&d.length)){console.log("runner,flowIdList:",d);for(let l=0;l<d.length;l++){const h=d[l],u=a.find(p=>p.code===h);u&&await this.execute(u.data,{pageInstance:n,schema:s,args:o})}}}}}const dt=new st;export{st as R,dt as r};
